const express = require('express')
const HTTPError = require('node-http-error')
const port = process.env.PORT || 8080
const app = express()
const dal = require('./dal.js')
const bodyParser = require('body-parser')
const jsonParser = bodyParser.json()
const helper = require('./helpme-functions.js')

///////////////////////////////////////////////////////
//////////////////   Helper        ///////////////////
//////////////////////////////////////////////////////

function reqObject (req) {
    return {
      method: req.method,
      path: req.path,
      query: req.query
    }
}
///////////////////////////////////////////////////////
//////////////////   Home          ///////////////////
//////////////////////////////////////////////////////
app.get('/', function (req, res) {
  res.send('My Book API')
})

///////////////////////////////////////////////////////
//////////////////   Retrieve Book: GET  //////////////
//////////////////////////////////////////////////////
app.get('/books/:id', function (req, res, next) {
  const bookId = req.params.id
  dal.getBookById(bookId, helper.cbDAL(req, res, next) )
})

///////////////////////////////////////////////////////
//////////////////   List of Books: GET ///////////////
//////////////////////////////////////////////////////

// Revist this
app.get('/books', function (req, res, next) {
  const sortBy = 'book/'
  const limit = req.query.limit || 3
  const startKey = ''
  dal.listBooks(sortBy, startKey, limit, helper.cbDAL(req, res, next))
})


///////////////////////////////////////////////////////
//////////////////   Add Book: POST ///////////////////
//////////////////////////////////////////////////////
app.post('/books', jsonParser, function (req, res, next) {
  if (!req.body)
  return next (new HTTPError(400, 'POST BODY is MIA!'), reqObject(req))
  dal.createBook(req.body, helper.cbDAL(req, res, next))
})

///////////////////////////////////////////////////////
//////////////////   Middleware  /////////////////////
//////////////////////////////////////////////////////
app.use(function(err, req, res, next) {
    console.log(err)
    res.status(err.status || 500).send(err)
})

///////////////////////////////////////////////////////
//////////////////   Port /////////////////////
//////////////////////////////////////////////////////
app.listen(port, function () {
  console.log('Listening on port: ', port)
})
